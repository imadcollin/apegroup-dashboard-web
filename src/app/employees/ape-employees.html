<link rel="import" href="../../assets/libs/polymer/polymer.html">
<link rel="import" href="../widgets/activity-wall/ape-activity-wall.html">
<link rel="import" href="../widgets/birthday-wall/ape-birthday-wall.html">

<dom-module id="ape-employees">

    <template>

        <style>

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            :host {
                padding: 4.8rem;
                display: flex;
                flex-direction: column;
                flex-grow: 1;
            }

            .widget[active] {
                animation: fadeIn .7s ease-in;
            }

            .widget:not([active]) {
                display: none;
            }

            ape-weather {
                padding: .8rem;
                flex-grow: 1;
            }

        </style>

        <ape-activity-wall users="[[allUsers]]" class="widget" active></ape-activity-wall>
        <ape-birthday-wall users="[[birthdayUsers]]" class="widget"></ape-birthday-wall>

    </template>

    <script>

        Polymer({

            is: `ape-employees`,

            behaviors: [

            ],

            properties: {
                visible: {
                    type: Boolean,
                    value: false
                },
                user: {
                    type: Object,
                    value: () => null
                },
                allUsers: {
                    type: Array,
                    value: () => null
                },
                birthdayUsers: {
                    type: Array,
                    value: () => null
                },
            },

            observers: [
                `_observerUserAndVisible(user, visible)`
            ],

            /* Life cycle */

            ready() {
                this._interval = 3000;
                this._activeIndex = 0;
            },

            attached() {

            },

            detached() {

            },

            _observerUserAndVisible(user, visible) {
                if (user && visible) {
                    this.activate();
                } else if (!user) {
                    this.deactivate();
                }
            },

            activate() {
                this.usersRef = firebase.database().ref(`/users`);
                this.usersRef.on(`value`, (data) => {
                    const items = data.val();
                    if (!this.allUsers) {
                        setTimeout(this._startTransitions.bind(this), this._interval);
                    }
                    this.allUsers = Object.keys(items).map(key => items[key]);
                    // this.birthdayUsers = this.allUsers.filter((user) => user.hasBirthdayToday === true);
                    this.birthdayUsers = this.allUsers.slice(0, 2);
                });
            },

            deactivate() {
                this.allUsers = [];
            },

            _startTransitions() {
                const widgets = Polymer.dom(this.root).querySelectorAll(`.widget`);
                widgets[this._activeIndex].removeAttribute(`active`);
                this._activeIndex += 1;
                if (this._activeIndex === widgets.length) {
                    this._activeIndex = 0;
                }
                widgets[this._activeIndex].setAttribute(`active`, ``);
                setTimeout(this._startTransitions.bind(this), this._interval);
            },



        });

    </script>

</dom-module>